From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Gravelbones <bojesen67@gmail.com>
Date: Sat, 18 Mar 2023 12:43:50 +0100
Subject: [PATCH] 5111: OMF format: Skip fixup for Comdat records

---
 .../ghidra/app/util/bin/format/omf/OmfFileHeader.java    | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java
index 39c79f9d5..681d012b5 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java
@@ -351,8 +351,10 @@ public class OmfFileHeader extends OmfRecord {
 				header.groups.add(group);
 			}
 			else if (record instanceof OmfFixupRecord fixuprec) {
-				fixuprec.setDataBlock(lastDataBlock);
-				header.fixup.add(fixuprec);
+				if(lastDataBlock != null) {
+					fixuprec.setDataBlock(lastDataBlock);
+					header.fixup.add(fixuprec);
+				}
 			}
 			else if (record instanceof OmfEnumeratedData enumheader) {
 				header.addEnumeratedBlock(enumheader);
@@ -368,6 +370,9 @@ public class OmfFileHeader extends OmfRecord {
 				lastDataBlock = iterheader;
 			}
 			else if (record instanceof OmfUnsupportedRecord) {
+				if (record.getRecordType() == COMDAT) {
+					lastDataBlock = null;
+				}
 				logRecord("Unsupported OMF record", record, log);
 			}
 			else if (record instanceof OmfObsoleteRecord) {
-- 
2.39.1

