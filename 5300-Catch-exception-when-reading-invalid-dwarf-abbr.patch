From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: William Tan <1284324+Ninja3047@users.noreply.github.com>
Date: Thu, 13 Apr 2023 17:23:27 -0400
Subject: [PATCH] 5300: Catch exception when reading invalid dwarf abbrev code
 and continue

---
 .../bin/format/dwarf4/DWARFCompilationUnit.java   | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/dwarf4/DWARFCompilationUnit.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/dwarf4/DWARFCompilationUnit.java
index c4ee046cc..a538299e7 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/dwarf4/DWARFCompilationUnit.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/dwarf4/DWARFCompilationUnit.java
@@ -351,8 +351,19 @@ public class DWARFCompilationUnit {
 		DebugInfoEntry parent = null;
 		DebugInfoEntry die;
 		DebugInfoEntry unexpectedTerminator = null;
-		while ((br.getPointerIndex() < getEndOffset()) &&
-			(die = DebugInfoEntry.read(br, this, dwarfProgram.getAttributeFactory())) != null) {
+		while ((br.getPointerIndex() < getEndOffset())) {
+			try {
+				die = DebugInfoEntry.read(br, this, dwarfProgram.getAttributeFactory());
+			}
+			catch (IOException ioe) {
+				Msg.error(null,
+					"Failed to parse the DW_TAG_compile_unit DIE at the start of compilation unit " +
+						this.compUnitNumber + " at offset " + this.startOffset + " (0x" +
+						Long.toHexString(this.startOffset) + "), skipping entire compilation unit",
+					ioe);
+				br.setPointerIndex(this.getEndOffset());
+				continue;
+			}
 
 			monitor.checkCancelled();
 
-- 
2.40.0

