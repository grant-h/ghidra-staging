From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Gravelbones <bojesen67@gmail.com>
Date: Sun, 26 Mar 2023 11:58:33 +0200
Subject: [PATCH] 5166: OMF format: Fix for comdat and fixup records

---
 .../java/ghidra/app/util/bin/format/omf/OmfFileHeader.java  | 6 ++----
 .../src/main/java/ghidra/app/util/opinion/OmfLoader.java    | 3 +++
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java
index 2dd3089ce..9574bc840 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/omf/OmfFileHeader.java
@@ -362,10 +362,8 @@ public class OmfFileHeader extends OmfRecord {
 				header.groups.add(group);
 			}
 			else if (record instanceof OmfFixupRecord fixuprec) {
-				if (lastDataBlock != null) {
-					fixuprec.setDataBlock(lastDataBlock);
-					header.fixup.add(fixuprec);
-				}
+				fixuprec.setDataBlock(lastDataBlock);
+				header.fixup.add(fixuprec);
 			}
 			else if (record instanceof OmfEnumeratedData enumheader) {
 				header.addEnumeratedBlock(enumheader);
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/opinion/OmfLoader.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/opinion/OmfLoader.java
index df9683efd..0ceccca1d 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/opinion/OmfLoader.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/opinion/OmfLoader.java
@@ -204,6 +204,9 @@ public class OmfLoader extends AbstractProgramWrapperLoader {
 					int method, index, locationType = -1;
 					locAddress = null;
 
+					if(fixup.getDataBlock() == null) {
+						continue;	// If no data block don't try to fixup
+					}
 					try {
 						if (subrec.isTargetThread()) {
 							Subrecord rec = targetThreads[subrec.getFixThreadNum()];
-- 
2.39.1

